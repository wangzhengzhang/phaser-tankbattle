<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>坦克大战</title>
    <style>
      @font-face {
        font-family: "iconfont";
        src: url("assets/iconfont/iconfont.ttf?t=1756727517214")
          format("truetype");
      }
      .iconfont {
        font-family: "iconfont" !important;
        font-size: 26px;
        font-style: normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color: #d0d0d0;
      }
      .iconfont:hover {
        color: white;
        cursor: pointer;
      }

      /* 基础样式重置 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Arial", sans-serif;
      }

      body {
        background-color: #f5f5f5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* 加载遮罩层 */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #1a1a1a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      /* 加载文字与图标容器 */
      .loading-title {
        color: #ffffff;
        font-size: 22px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
      }

      /* 加载旋转图标（原生CSS实现） */
      .spin-icon {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: #ffffff;
        border-radius: 50%;
        margin-right: 12px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 进度条容器 */
      .progress-container {
        width: 90%;
        max-width: 400px;
        height: 24px;
        background-color: #333333;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      /* 进度条（带流光动画） */
      .progress-bar {
        height: 100%;
        width: 0%;
        background-color: #4a90e2;
        border-radius: 12px;
        transition: width 0.3s ease-out;
        position: relative;
        overflow: hidden;
      }

      .progress-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        animation: shine 1.5s infinite;
      }

      @keyframes shine {
        to {
          left: 100%;
        }
      }

      /* 进度信息区域 */
      .progress-info {
        width: 90%;
        max-width: 400px;
        display: flex;
        justify-content: space-between;
        color: #bbbbbb;
        font-size: 14px;
      }

      /* 错误状态样式 */
      .error-text {
        color: #ff4444;
      }

      /* 主内容区域（默认隐藏） */
      #main-content {
        flex: 1;

        margin: 0 auto;
        padding: 10px 0;
        display: none;
      }

      .main-title {
        font-size: 32px;
        color: #222222;
        margin-bottom: 20px;
      }

      .main-desc {
        font-size: 18px;
        color: #555555;
        line-height: 1.6;
      }
    </style>
  </head>
  <body>
    <!-- 加载遮罩层 -->
    <div id="loading-overlay">
      <div class="loading-title">
        <div class="spin-icon"></div>
        <span>坦克大战</span>
      </div>

      <!-- 进度条容器 -->
      <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>

      <!-- 进度信息 -->
      <div class="progress-info">
        <span id="progress-text">0%</span>
        <span id="current-file">准备加载...</span>
      </div>
    </div>

    <!-- 主内容区 (加载完成后显示) -->
    <main id="main-content">
      <!-- 嵌入外部HTML页面 -->
    </main>

    <script>
      // 加载并插入外部HTML
      async function includeHTML(url, containerId) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("加载失败");

          const html = await response.text();
          document.getElementById(containerId).innerHTML = html;

          // 可选：如果加载的HTML中包含脚本，需要手动执行
          executeScripts(document.getElementById(containerId));
        } catch (error) {
          console.error("加载HTML出错:", error);
        }
      }

      // 执行动态加载的脚本
      function executeScripts(container) {
        const scripts = container.querySelectorAll("script");
        scripts.forEach((oldScript) => {
          const newScript = document.createElement("script");
          // 复制所有属性
          Array.from(oldScript.attributes).forEach((attr) => {
            newScript.setAttribute(attr.name, attr.value);
          });
          newScript.textContent = oldScript.textContent;
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      // 加载并包含header.html到页面中
      includeHTML("main.html", "main-content");

      // 1. 配置需要加载的JS文件列表（按依赖顺序排列）
      const jsFiles = [
        // 先加载引擎，再加载业务逻辑
        "phaser.min.js", // 加载引擎
        "navmesh_generator.js", // 加载地图导航网格工具库
        "astar_findpath.js", // 基于Tile网格的路径规划算法
        "sprite_executor_path.js", // 基于Tile网格和 physics物理引擎 的路径执行器
        "resource.js", // 加载资源

        "common.js", // 角色通用函数库
        "sprite_player.js", // 玩家
        "sprite_enemy.js", // 敌人玩家
        "sprite_bullet.js", // 子弹

        "scene_loader.js", // 等待加载场景
        "scene_main.js", // 游戏场景

        "game.js", // 游戏全局对象(在这里初始化全局game对象)
      ];

      // 2. 加载状态跟踪变量
      let loadedCount = 0; // 已加载完成的文件数
      const totalFiles = jsFiles.length; // 总文件数

      // 3. 获取DOM元素（避免重复查询）
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      const currentFile = document.getElementById("current-file");
      const loadingOverlay = document.getElementById("loading-overlay");
      const mainContent = document.getElementById("main-content");

      // 4. 更新进度条与文本
      function updateProgress() {
        // 计算当前进度（四舍五入为整数百分比）
        const progressPercent = Math.round((loadedCount / totalFiles) * 100);
        // 更新进度条宽度和文本
        progressBar.style.width = `${progressPercent}%`;
        progressText.textContent = `${progressPercent}%`;

        // 所有文件加载完成后的处理
        if (loadedCount === totalFiles) {
          //延迟0.5秒再隐藏加载层（让进度条完成动画）
          setTimeout(() => {
            loadingOverlay.style.opacity = "0";
            // 完全隐藏后显示主内容
            setTimeout(() => {
              loadingOverlay.style.display = "none";
              mainContent.style.display = "block";
              // 初始化应用（所有文件已加载完成）
              initApplication();
            }, 500);
          }, 500);

          //window.location.href = "./main.html";
        }
      }

      // 5. 单个JS文件加载函数（返回Promise便于顺序控制）
      function loadSingleScript(filePath) {
        return new Promise((resolve, reject) => {
          // 提取文件名（用于显示当前加载项）
          const fileName = filePath.split("/").pop();
          currentFile.textContent = `加载中: ${fileName}`;

          // 创建script标签
          const script = document.createElement("script");
          script.src = filePath;
          script.type = "text/javascript";

          // 加载成功回调
          script.onload = () => {
            loadedCount++; // 已加载计数+1
            updateProgress(); // 更新进度
            resolve(); // 通知Promise完成
          };

          // 加载失败回调
          script.onerror = (error) => {
            // 打印错误信息（便于调试）
            console.error(`文件加载失败: ${filePath}`, error);
            // 显示错误提示
            currentFile.textContent = `加载失败: ${fileName}`;
            currentFile.classList.add("error-text");
            // 通知Promise失败
            reject(new Error(`加载文件 ${filePath} 时出错`));
          };

          // 将script标签添加到页面（开始加载）
          document.head.appendChild(script);
        });
      }

      // 6. 批量加载所有JS文件（顺序加载，保证依赖正确）
      async function loadAllScripts() {
        try {
          // 循环加载每个文件（await确保顺序执行）
          for (const file of jsFiles) {
            await loadSingleScript(file);
          }
        } catch (error) {
          // 捕获加载过程中的错误（避免程序崩溃）
          console.error("JS文件加载过程出错:", error);
        }
      }

      // 7. 应用初始化函数（所有文件加载完成后执行）
      function initApplication() {
        console.log("✅ 所有JS文件加载完成，开始初始化应用");
        // 示例：如果加载了Phaser，可在此处创建游戏实例
        if (window.Phaser) {
          console.log("✅ Phaser引擎已就绪，可创建游戏");
          // 此处可添加你的游戏初始化代码（如new Phaser.Game(config)）
        }
        // 其他初始化逻辑...
        //loadContent("./main.html");
      }

      // 8. 页面DOM加载完成后开始加载JS文件
      window.addEventListener("DOMContentLoaded", loadAllScripts);
    </script>
  </body>
</html>
